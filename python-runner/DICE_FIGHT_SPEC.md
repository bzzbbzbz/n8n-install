# üé≤ –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è: PvP Dice Fights (–î—Ä–∞–∫–∏)

## –û–±–∑–æ—Ä —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è PvP-–º–µ—Ö–∞–Ω–∏–∫–∏ "–¥—Ä–∞–∫–∏" ‚Äî –∏–≥—Ä–æ–∫–∏ –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –Ω–∞ –¥—É—ç–ª—å –≤ –∫–æ—Å—Ç–∏. –ü–æ–±–µ–¥–∏—Ç–µ–ª—å –∑–∞–±–∏—Ä–∞–µ—Ç —Å—Ç–∞–≤–∫—É –ø—Ä–æ–∏–≥—Ä–∞–≤—à–µ–≥–æ. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–æ–ª–≥–æ–≤ –¥–æ -100 –æ—á–∫–æ–≤ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤–∑—ã—Å–∫–∞–Ω–∏—è —á–µ—Ä–µ–∑ `/take`.

---

## 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### 1.1. –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞: `dice_challenges`

–•—Ä–∞–Ω–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –Ω–∞ –¥—É—ç–ª—å.

```sql
CREATE TABLE IF NOT EXISTS dice_challenges (
    challenge_id TEXT PRIMARY KEY,
    chat_id INTEGER NOT NULL,
    initiator_id INTEGER NOT NULL,
    initiator_nickname TEXT,
    opponent_id INTEGER,                    -- NULL –ø–æ–∫–∞ –Ω–µ –ø—Ä–∏–Ω—è—Ç–æ
    opponent_nickname TEXT,
    bet_amount INTEGER NOT NULL,
    initiator_going_debt BOOLEAN DEFAULT 0, -- —É—Ö–æ–¥–∏—Ç –ª–∏ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä –≤ –¥–æ–ª–≥
    status TEXT DEFAULT 'pending',          -- pending, accepted, rolling, completed, cancelled, expired
    initiator_roll INTEGER,                 -- —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—Ä–æ—Å–∫–∞ (1-6)
    opponent_roll INTEGER,
    winner_id INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    accepted_at DATETIME,
    completed_at DATETIME,
    message_id INTEGER,                     -- ID —Å–æ–æ–±—â–µ–Ω–∏—è —Å inline-–∫–Ω–æ–ø–∫–æ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    FOREIGN KEY(initiator_id) REFERENCES users(user_id),
    FOREIGN KEY(opponent_id) REFERENCES users(user_id)
)
```

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_challenges_status ON dice_challenges(status);
CREATE INDEX idx_challenges_chat ON dice_challenges(chat_id, status);
CREATE INDEX idx_challenges_initiator ON dice_challenges(initiator_id, status);
```

### 1.2. –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞: `player_debts`

–•—Ä–∞–Ω–∏—Ç –¥–æ–ª–≥–∏ –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–∞–º–∏.

```sql
CREATE TABLE IF NOT EXISTS player_debts (
    debt_id TEXT PRIMARY KEY,
    chat_id INTEGER NOT NULL,
    debtor_id INTEGER NOT NULL,             -- –∫—Ç–æ –¥–æ–ª–∂–µ–Ω
    creditor_id INTEGER NOT NULL,           -- –∫–æ–º—É –¥–æ–ª–∂–µ–Ω
    amount INTEGER NOT NULL,                -- —Å–∫–æ–ª—å–∫–æ –¥–æ–ª–∂–µ–Ω (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ)
    challenge_id TEXT,                      -- —Å–≤—è–∑—å —Å –¥—É—ç–ª—å—é, –ø–æ—Ä–æ–¥–∏–≤—à–µ–π –¥–æ–ª–≥
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY(debtor_id) REFERENCES users(user_id),
    FOREIGN KEY(creditor_id) REFERENCES users(user_id),
    FOREIGN KEY(challenge_id) REFERENCES dice_challenges(challenge_id),
    UNIQUE(chat_id, debtor_id, creditor_id) -- –æ–¥–∏–Ω –¥–æ–ª–≥ –Ω–∞ –ø–∞—Ä—É –≤ —á–∞—Ç–µ
)
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –î–æ–ª–≥ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –º–µ–∂–¥—É –¥–≤—É–º—è –∏–≥—Ä–æ–∫–∞–º–∏ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —á–∞—Ç–µ. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –¥—Ä–∞–∫–∞—Ö –¥–æ–ª–≥ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è (UPDATE amount = amount + X).

**–í–∑–∞–∏–º–æ–∑–∞—á—ë—Ç –¥–æ–ª–≥–æ–≤:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –¥–æ–ª–≥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ –≤—Å—Ç—Ä–µ—á–Ω–æ–≥–æ –¥–æ–ª–≥–∞. –ï—Å–ª–∏ A –¥–æ–ª–∂–µ–Ω B –∏ B –¥–æ–ª–∂–µ–Ω A, –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–∑–∞–∏–º–æ–∑–∞—á—ë—Ç:
- A –¥–æ–ª–∂–µ–Ω B: 200, B –¥–æ–ª–∂–µ–Ω A: 100 ‚Üí –ü–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–∑–∞—á—ë—Ç–∞: A –¥–æ–ª–∂–µ–Ω B: 100, –¥–æ–ª–≥ B —É–¥–∞–ª—è–µ—Ç—Å—è
- –≠—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–π –ª–∏–º–∏—Ç –¥–ª—è —Å—Ç–∞–≤–æ–∫ (–∏–≥—Ä–æ–∫ —Å –º–µ–Ω—å—à–∏–º —á–∏—Å—Ç—ã–º –¥–æ–ª–≥–æ–º –º–æ–∂–µ—Ç —Å—Ç–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ)

### 1.3. –ù–æ–≤—ã–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π –≤ `event_history`

| event_type | –û–ø–∏—Å–∞–Ω–∏–µ | amount | metadata |
|------------|----------|--------|----------|
| `dice_challenge_win` | –í—ã–∏–≥—Ä—ã—à –≤ –¥—É—ç–ª–∏ | +—Å—É–º–º–∞ –≤—ã–∏–≥—Ä—ã—à–∞ | `{"challenge_id": "...", "opponent_id": ..., "rolls": [X, Y]}` |
| `dice_challenge_loss` | –ü—Ä–æ–∏–≥—Ä—ã—à –≤ –¥—É—ç–ª–∏ | -—Å—É–º–º–∞ –ø—Ä–æ–∏–≥—Ä—ã—à–∞ | `{"challenge_id": "...", "opponent_id": ..., "rolls": [X, Y]}` |
| `dice_challenge_draw` | –ù–∏—á—å—è | 0 | `{"challenge_id": "...", "opponent_id": ..., "rolls": [X, X]}` |
| `debt_created` | –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–ª–≥–∞ | -—Å—É–º–º–∞ | `{"challenge_id": "...", "creditor_id": ...}` |
| `debt_collected` | –í–∑—ã—Å–∫–∞–Ω–∏–µ –¥–æ–ª–≥–∞ | +/-—Å—É–º–º–∞ | `{"debt_id": "...", "debtor_id": ..., "creditor_id": ...}` |

---

## 2. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

### 2.1. –°–æ–∑–¥–∞–Ω–∏–µ –≤—ã–∑–æ–≤–∞ (`/dice <—Å—É–º–º–∞>`)

**–£—Å–ª–æ–≤–∏—è:**
- –ö–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö –∏–∑ `allowed_chat_ids`
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: 1
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: `balance + 100` (–Ω–æ –Ω–µ –±–æ–ª–µ–µ 100 –≤ –¥–æ–ª–≥)
- –ï—Å–ª–∏ `bet > balance`: –ø–æ–º–µ—á–∞–µ–º `initiator_going_debt = true`
- –ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –≤—ã–∑–æ–≤, –µ—Å–ª–∏ —É –∏–≥—Ä–æ–∫–∞ —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ (status = pending/accepted/rolling)

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```python
max_bet = max(0, balance) + 100  # –º–æ–∂–Ω–æ —É–π—Ç–∏ –≤ –¥–æ–ª–≥ –¥–æ -100
if bet < 1:
    return "–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: 1"
if bet > max_bet:
    return f"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: {max_bet}"
if balance - bet < -100:
    return "–ù–µ–ª—å–∑—è —É–π—Ç–∏ –≤ –¥–æ–ª–≥ –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 100"
```

**–°–æ–æ–±—â–µ–Ω–∏–µ –≤—ã–∑–æ–≤–∞:**
```
üé≤ –í–´–ó–û–í –ù–ê –î–£–≠–õ–¨!

üë§ {nickname} —Å—Ç–∞–≤–∏—Ç {bet} –æ—á–∫–æ–≤!
{–µ—Å–ª–∏ going_debt: "‚ö†Ô∏è –ò–≥—Ä–æ–∫ –∏–¥—ë—Ç –≤ –¥–æ–ª–≥!"}

üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ {bet} –¥–ª—è —É—á–∞—Å—Ç–∏—è.

[–ü—Ä–∏–Ω—è—Ç—å –≤—ã–∑–æ–≤]  [üö´ –æ—Ç–º–µ–Ω–∞ ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞]
```

### 2.2. –û—Ç–º–µ–Ω–∞ –≤—ã–∑–æ–≤–∞

- –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å –≤—ã–∑–æ–≤ –¥–æ –ø—Ä–∏–Ω—è—Ç–∏—è
- Inline-–∫–Ω–æ–ø–∫–∞ "üö´" –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä—É (–ø—Ä–æ–≤–µ—Ä–∫–∞ callback_query.from_user.id)
- –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ: `status = 'cancelled'`, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ

### 2.3. –ü—Ä–∏–Ω—è—Ç–∏–µ –≤—ã–∑–æ–≤–∞ (inline callback)

**–£—Å–ª–æ–≤–∏—è:**
- –ù–µ–ª—å–∑—è –ø—Ä–∏–Ω—è—Ç—å —Å–≤–æ–π –≤—ã–∑–æ–≤
- –ë–∞–ª–∞–Ω—Å –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–≥–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å >= bet –ò–õ–ò `balance + 100 >= bet` (–ø—Ä–∏–Ω–∏–º–∞—é—â–∏–π —Ç–æ–∂–µ –º–æ–∂–µ—Ç –∏–¥—Ç–∏ –≤ –¥–æ–ª–≥)
- –ü—Ä–æ–≤–µ—Ä–∫–∞: `opponent_balance - bet >= -100`

**–ü—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏:**
1. `status = 'accepted'`, –∑–∞–ø–∏—Å—ã–≤–∞–µ–º `opponent_id`, `opponent_nickname`, `accepted_at`
2. –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ:
```
üé≤ –î–£–≠–õ–¨ –ù–ê–ß–ê–õ–ê–°–¨!

üë§ {initiator} vs üë§ {opponent}
üí∞ –°—Ç–∞–≤–∫–∞: {bet}

–ë—Ä–æ—Å–∞–π—Ç–µ –∫—É–±–∏–∫! üé≤
(–û—Ç–ø—Ä–∞–≤—å—Ç–µ dice-—ç–º–æ–¥–∑–∏ –≤ —á–∞—Ç)

‚è± –í—Ä–µ–º—è –Ω–∞ –±—Ä–æ—Å–æ–∫: 5 –º–∏–Ω—É—Ç
```

### 2.4. –ë—Ä–æ—Å–∫–∏ –∫–æ—Å—Ç–µ–π

**–ú–µ—Ö–∞–Ω–∏–∫–∞:**
- –ü–æ—Å–ª–µ –ø—Ä–∏–Ω—è—Ç–∏—è –≤—ã–∑–æ–≤–∞ (`status = 'accepted'`) –æ–∂–∏–¥–∞–µ–º dice –æ—Ç –æ–±–æ–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –§–∏–ª—å—Ç—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è: `F.dice.emoji == 'üé≤'` –æ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ç–µ–∫—É—â–µ–π –¥—É—ç–ª–∏
- –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ `initiator_roll` / `opponent_roll`
- –ö–æ–≥–¥–∞ –æ–±–∞ –±—Ä–æ—Å–∏–ª–∏ (–∏–ª–∏ –ø–æ —Ç–∞–π–º–∞—É—Ç—É) ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É

**–ê–≤—Ç–æ–±—Ä–æ—Å–æ–∫ –ø–æ —Ç–∞–π–º–∞—É—Ç—É (5 –º–∏–Ω—É—Ç):**
- –ò—Å–ø–æ–ª—å–∑—É–µ–º APScheduler job –Ω–∞ 5 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ `accepted_at`
- –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –Ω–µ –±—Ä–æ—Å–∏–ª ‚Üí –±–æ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç random.randint(1, 6)
- –°–æ–æ–±—â–µ–Ω–∏–µ: `"‚è∞ {nickname} –Ω–µ —É—Å–ø–µ–ª –±—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫! –ë–æ—Ç –±—Ä–æ—Å–∞–µ—Ç –∑–∞ –Ω–µ–≥–æ: üé≤ {value}"`

### 2.5. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è

```python
if initiator_roll > opponent_roll:
    winner_id = initiator_id
    loser_id = opponent_id
elif opponent_roll > initiator_roll:
    winner_id = opponent_id
    loser_id = initiator_id
else:
    # –ù–∏—á—å—è
    winner_id = None
```

### 2.6. –†–∞—Å—á—ë—Ç –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤

**–ü—Ä–∏ –ø–æ–±–µ–¥–µ:**
```python
# –ü–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞–≤–∫—É
winner_gains = bet
loser_loses = bet

# –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å—ã
new_loser_balance = loser_balance - bet

# –ï—Å–ª–∏ –ø—Ä–æ–∏–≥—Ä–∞–≤—à–∏–π —É—Ö–æ–¥–∏—Ç –≤ –¥–æ–ª–≥
if new_loser_balance < 0:
    # –°–∫–æ–ª—å–∫–æ –æ–Ω —Ä–µ–∞–ª—å–Ω–æ –º–æ–∂–µ—Ç –æ—Ç–¥–∞—Ç—å –∏–∑ –±–∞–ª–∞–Ω—Å–∞
    actual_from_balance = max(0, loser_balance)
    
    # –û—Å—Ç–∞—Ç–æ–∫ ‚Äî —ç—Ç–æ –¥–æ–ª–≥
    debt_amount = bet - actual_from_balance
    
    # –ü–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –±—ã–ª–æ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ
    winner_gains = actual_from_balance
    
    # –°–æ–∑–¥–∞—ë–º/—É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–æ–ª–≥
    create_or_update_debt(loser_id, winner_id, debt_amount, chat_id)
    
    # –ë–∞–ª–∞–Ω—Å –ø—Ä–æ–∏–≥—Ä–∞–≤—à–µ–≥–æ = 0 (–Ω–µ –º–∏–Ω—É—Å!)
    new_loser_balance = 0
```

**–í–∞–∂–Ω–æ:** –ë–∞–ª–∞–Ω—Å –∏–≥—Ä–æ–∫–∞ –ù–ï —É—Ö–æ–¥–∏—Ç –≤ –º–∏–Ω—É—Å. –ú–∏–Ω—É—Å ‚Äî —ç—Ç–æ –¥–æ–ª–≥, –∫–æ—Ç–æ—Ä—ã–π —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `player_debts`.

**–ü—Ä–∏ –Ω–∏—á—å–µ–π:**
- –ù–∏—á–µ–≥–æ –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ–º
- –°–æ–æ–±—â–µ–Ω–∏–µ: "ü§ù –ù–∏—á—å—è! –û—á–∫–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –∏–≥—Ä–æ–∫–∞–º."

### 2.7. –°–æ–æ–±—â–µ–Ω–∏—è –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ

**–ü–æ–±–µ–¥–∞/–ü–æ—Ä–∞–∂–µ–Ω–∏–µ ‚Äî —è—Ä–∫–∏–µ —Ñ—Ä–∞–∑—ã:**

```python
FIGHT_WIN_PHRASES = [
    "üí™ {winner} –£–ù–ò–ß–¢–û–ñ–ò–õ {loser}! –ó–∞–±–∏—Ä–∞–µ—Ç {amount} –æ—á–∫–æ–≤!",
    "üèÜ {winner} –ø–æ–∫–∞–∑–∞–ª, –∫—Ç–æ —Ç—É—Ç –±–æ—Å—Å! +{amount} –≤ –∫–∞—Ä–º–∞–Ω!",
    "üòé {winner} –æ—Å—Ç–∞–≤–∏–ª {loser} –±–µ–∑ —à—Ç–∞–Ω–æ–≤! –õ—ë–≥–∫–∏–µ {amount} –æ—á–∫–æ–≤!",
    "üî• FATALITY! {winner} –≤—ã–Ω–æ—Å–∏—Ç {loser} –∏ –∑–∞–±–∏—Ä–∞–µ—Ç {amount}!",
    "üëë {winner} ‚Äî –Ω–æ–≤—ã–π –∫–æ—Ä–æ–ª—å —Ä–∏–Ω–≥–∞! {loser} –æ—Ç–¥–∞—ë—Ç {amount} –æ—á–∫–æ–≤!",
    "üé∞ –£–¥–∞—á–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ {winner}! {loser} –ø–ª–∞—á–µ—Ç –∏ –æ—Ç–¥–∞—ë—Ç {amount}!",
    "‚ö°Ô∏è {winner} –±—Ä–æ—Å–∏–ª –∫—É–±–∏–∫ —Å—É–¥—å–±—ã –∏ –∑–∞–±—Ä–∞–ª {amount} —É {loser}!",
    "ü•ä –ù–æ–∫–∞—É—Ç! {winner} –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç {loser} –≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –Ω–æ–∫–¥–∞—É–Ω!",
    "üí∏ {loser} —Å–ø–æ–Ω—Å–∏—Ä—É–µ—Ç –ø–æ–±–µ–¥—É {winner} –Ω–∞ {amount} –æ—á–∫–æ–≤!",
    "üéØ –¢–æ—á–Ω–æ –≤ —Ü–µ–ª—å! {winner} —Å–Ω–∏–º–∞–µ—Ç {amount} —Å {loser}!",
]

FIGHT_LOSE_DEBT_PHRASES = [
    "üíÄ {loser} –Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–∏–≥—Ä–∞–ª, –Ω–æ –µ—â—ë –∏ –æ—Å—Ç–∞–ª—Å—è –¥–æ–ª–∂–µ–Ω {debt} –æ—á–∫–æ–≤!",
    "üìâ {loser} —É—à—ë–ª –≤ –º–∏–Ω—É—Å! –î–æ–ª–≥: {debt} –æ—á–∫–æ–≤. –ö–æ–ª–ª–µ–∫—Ç–æ—Ä—ã —É–∂–µ –≤ –ø—É—Ç–∏!",
    "üèö {loser} —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–µ–Ω {winner} —Ü–µ–ª—ã—Ö {debt} –æ—á–∫–æ–≤! –ì–æ—Ç–æ–≤—å –ø–æ—á–∫—É!",
    "üò± {loser} –≤–ª–µ–∑ –≤ –¥–æ–ª–≥–æ–≤—É—é —è–º—É –Ω–∞ {debt} –æ—á–∫–æ–≤! /take –∂–¥—ë—Ç —Å–≤–æ–µ–≥–æ —á–∞—Å–∞!",
    "üîª –ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è {loser} –ø–æ–ø–æ–ª–Ω–∏–ª–∞—Å—å –¥–æ–ª–≥–æ–º –≤ {debt} –æ—á–∫–æ–≤!",
]

FIGHT_DRAW_PHRASES = [
    "ü§ù –ù–∏—á—å—è! –û–±–∞ –≤—ã–±—Ä–æ—Å–∏–ª–∏ {roll}. –î–µ–Ω—å–≥–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–∏ —Å–≤–æ–∏—Ö!",
    "‚öñÔ∏è –°—É–¥—å–±–∞ —Ä–µ—à–∏–ª–∞: {roll} = {roll}. –†–∞—Å—Ö–æ–¥–∏–º—Å—è –º–∏—Ä–Ω–æ!",
    "üé≠ –ë–æ–≥–∏ —Ä–∞–Ω–¥–æ–º–∞ –ø–æ—à—É—Ç–∏–ª–∏ ‚Äî –Ω–∏—á—å—è {roll}:{roll}!",
    "ü™¢ –£–∑–µ–ª –Ω–∞ –∫—É–±–∏–∫–∞—Ö! {roll} –ø—Ä–æ—Ç–∏–≤ {roll}. –ù–∏–∫—Ç–æ –Ω–µ –≤ –æ–±–∏–¥–µ!",
    "üòê –°–∫—É—á–Ω–∞—è –Ω–∏—á—å—è {roll}:{roll}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑!",
]
```

**–§–æ—Ä–º–∞—Ç –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:**

```
üé≤ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –î–£–≠–õ–ò

{initiator}: üé≤ {initiator_roll}
{opponent}: üé≤ {opponent_roll}

{FIGHT_PHRASE}

{–µ—Å–ª–∏ –¥–æ–ª–≥: "üìã –î–æ–ª–≥ {loser} –ø–µ—Ä–µ–¥ {winner}: {debt} –æ—á–∫–æ–≤. –í–∑—ã—Å–∫–∞—Ç—å: /take {debt} @{loser}"}

üí∞ –ë–∞–ª–∞–Ω—Å {winner}: {new_balance}
üí∞ –ë–∞–ª–∞–Ω—Å {loser}: {new_balance} {–µ—Å–ª–∏ –¥–æ–ª–≥: "(–¥–æ–ª–∂–µ–Ω {debt})"}
```

---

## 3. –ö–æ–º–∞–Ω–¥–∞ `/take`

### 3.1. –°–∏–Ω—Ç–∞–∫—Å–∏—Å

```
/take <—Å—É–º–º–∞> @username
/take <—Å—É–º–º–∞> (—Ä–µ–ø–ª–∞–µ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)
```

### 3.2. –õ–æ–≥–∏–∫–∞

```python
@router.message(Command("take"))
async def cmd_take(message, command, db):
    creditor_id = message.from_user.id
    
    # –ü–∞—Ä—Å–∏–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
    amount, debtor = parse_args(command.args, message.reply_to_message)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–æ–ª–≥
    debt = await db.get_debt(chat_id, debtor_id, creditor_id)
    if not debt or debt['amount'] <= 0:
        return "–≠—Ç–æ—Ç –∏–≥—Ä–æ–∫ —Ç–µ–±–µ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–ª–∂–µ–Ω!"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É–º–º—É
    if amount > debt['amount']:
        return f"–î–æ–ª–≥ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ {debt['amount']}. –ù–µ–ª—å–∑—è –∑–∞–±—Ä–∞—Ç—å –±–æ–ª—å—à–µ!"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –¥–æ–ª–∂–Ω–∏–∫–∞
    debtor_balance = await db.get_balance(debtor_id)
    if debtor_balance <= 0:
        return f"–£ @{debtor_nickname} –±–∞–ª–∞–Ω—Å {debtor_balance}. –ñ–¥–∏—Ç–µ, –ø–æ–∫–∞ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç!"
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—É—é —Å—É–º–º—É –≤–∑—ã—Å–∫–∞–Ω–∏—è
    actual_amount = min(amount, debtor_balance, debt['amount'])
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    await db.collect_debt(creditor_id, debtor_id, actual_amount, chat_id)
    
    # –°–æ–æ–±—â–µ–Ω–∏–µ
    return f"üí∞ –í–∑—ã—Å–∫–∞–Ω–æ {actual_amount} –æ—á–∫–æ–≤ —Å @{debtor}!"
```

### 3.3. –ú–µ—Ç–æ–¥ –ë–î `collect_debt`

```python
async def collect_debt(self, creditor_id, debtor_id, amount, chat_id):
    async with aiosqlite.connect(self.db_path) as db:
        # –°–ø–∏—Å—ã–≤–∞–µ–º —Å –¥–æ–ª–∂–Ω–∏–∫–∞
        await db.execute(
            "UPDATE users SET balance = balance - ? WHERE user_id = ?",
            (amount, debtor_id)
        )
        # –ó–∞—á–∏—Å–ª—è–µ–º –∫—Ä–µ–¥–∏—Ç–æ—Ä—É
        await db.execute(
            "UPDATE users SET balance = balance + ? WHERE user_id = ?",
            (amount, creditor_id)
        )
        # –£–º–µ–Ω—å—à–∞–µ–º –¥–æ–ª–≥
        await db.execute(
            "UPDATE player_debts SET amount = amount - ?, updated_at = CURRENT_TIMESTAMP WHERE debtor_id = ? AND creditor_id = ? AND chat_id = ?",
            (amount, debtor_id, creditor_id, chat_id)
        )
        # –£–¥–∞–ª—è–µ–º –¥–æ–ª–≥ –µ—Å–ª–∏ –ø–æ–≥–∞—à–µ–Ω
        await db.execute(
            "DELETE FROM player_debts WHERE amount <= 0"
        )
        # –°–æ–±—ã—Ç–∏—è
        event_id = str(uuid.uuid4())
        metadata = json.dumps({"debtor_id": debtor_id, "creditor_id": creditor_id})
        await db.execute(
            "INSERT INTO event_history (event_id, user_id, event_type, amount, metadata, chat_id) VALUES (?, ?, 'debt_collected', ?, ?, ?)",
            (event_id, creditor_id, amount, metadata, chat_id)
        )
        await db.execute(
            "INSERT INTO event_history (event_id, user_id, event_type, amount, metadata, chat_id) VALUES (?, ?, 'debt_collected', ?, ?, ?)",
            (str(uuid.uuid4()), debtor_id, -amount, metadata, chat_id)
        )
        await db.commit()
```

---

## 4. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `/stats`

### 4.1. –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É PvP

–í –∑–∞–ø—Ä–æ—Å `get_top_users_in_group` –¥–æ–±–∞–≤–∏—Ç—å:
- `dice_wins` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–±–µ–¥ –≤ –¥—É—ç–ª—è—Ö
- `dice_losses` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä–∞–∂–µ–Ω–∏–π
- `dice_draws` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∏—á—å–∏—Ö

```sql
-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏:
SUM(CASE WHEN event_type = 'dice_challenge_win' THEN 1 ELSE 0 END) as dice_wins,
SUM(CASE WHEN event_type = 'dice_challenge_loss' THEN 1 ELSE 0 END) as dice_losses,
SUM(CASE WHEN event_type = 'dice_challenge_draw' THEN 1 ELSE 0 END) as dice_draws
```

### 4.2. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–≥–∞

```python
# –í —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—Ç—Ä–æ–∫–∏ /stats:
debt_info = ""
total_debt = await db.get_total_debt_by_user(user_id, chat_id)
if total_debt:
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É "–¥–æ–ª–∂–µ–Ω X –∏–≥—Ä–æ–∫—É Y, Z –∏–≥—Ä–æ–∫—É W..."
    debt_parts = [f"{d['amount']} @{d['creditor_nickname']}" for d in total_debt]
    debt_info = f"\n      üìã –î–æ–ª–∂–µ–Ω: {', '.join(debt_parts)}"

text.append(f"{idx}. <b>{nickname}</b> ‚Äî {balance} –æ—á–∫–æ–≤{debt_info}{stats_part}")
```

### 4.3. –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞

```
üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤ —á–∞—Ç–∞ Casino Kings:

1. @winner ‚Äî 500 –æ—á–∫–æ–≤
      üé∞ –í—Å–µ–≥–æ –∏–≥—Ä: 50
      üìà –í—ã–∏–≥—Ä–∞–Ω–æ: 300 | –ü–æ—Ç—Ä–∞—á–µ–Ω–æ: 150 | WR: 66.67%
      ‚öîÔ∏è –î—É—ç–ª–∏: 10W / 3L / 2D
      üíÄ –ë–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤: 0

2. @loser ‚Äî 20 –æ—á–∫–æ–≤
      üìã –î–æ–ª–∂–µ–Ω: 80 @winner
      üé∞ –í—Å–µ–≥–æ –∏–≥—Ä: 30
      üìà –í—ã–∏–≥—Ä–∞–Ω–æ: 100 | –ü–æ—Ç—Ä–∞—á–µ–Ω–æ: 200 | WR: 33.33%
      ‚öîÔ∏è –î—É—ç–ª–∏: 3W / 10L / 2D
      üíÄ –ë–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤: 2
```

---

## 5. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### 5.1. –ù–æ–≤—ã–π handler: `bot/handlers/dice_fight.py`

```
bot/handlers/dice_fight.py
‚îú‚îÄ‚îÄ router = Router()
‚îú‚îÄ‚îÄ FIGHT_WIN_PHRASES = [...]
‚îú‚îÄ‚îÄ FIGHT_LOSE_DEBT_PHRASES = [...]
‚îú‚îÄ‚îÄ FIGHT_DRAW_PHRASES = [...]
‚îú‚îÄ‚îÄ 
‚îú‚îÄ‚îÄ @router.message(Command("dice"))
‚îÇ   async def cmd_dice(message, command, db, game_config)
‚îÇ
‚îú‚îÄ‚îÄ @router.callback_query(F.data.startswith("dice_accept:"))
‚îÇ   async def on_dice_accept(callback, db)
‚îÇ
‚îú‚îÄ‚îÄ @router.callback_query(F.data.startswith("dice_cancel:"))
‚îÇ   async def on_dice_cancel(callback, db)
‚îÇ
‚îú‚îÄ‚îÄ @router.message(F.dice.emoji == "üé≤", ActiveDuelFilter())
‚îÇ   async def on_dice_roll(message, db)
‚îÇ
‚îú‚îÄ‚îÄ @router.message(Command("take"))
‚îÇ   async def cmd_take(message, command, db)
‚îÇ
‚îú‚îÄ‚îÄ class ActiveDuelFilter(Filter):
‚îÇ   """–§–∏–ª—å—Ç—Ä: –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –¥—É—ç–ª—å –≤ —á–∞—Ç–µ —Å —É—á–∞—Å—Ç–∏–µ–º –∞–≤—Ç–æ—Ä–∞"""
‚îÇ
‚îú‚îÄ‚îÄ async def process_duel_result(db, bot, challenge)
‚îÇ   """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ—Å–ª–µ –æ–±–æ–∏—Ö –±—Ä–æ—Å–∫–æ–≤"""
‚îÇ
‚îú‚îÄ‚îÄ async def auto_roll_timeout_job(challenge_id, db, bot)
‚îÇ   """Job –¥–ª—è –∞–≤—Ç–æ–±—Ä–æ—Å–∫–∞ –ø–æ —Ç–∞–π–º–∞—É—Ç—É"""
```

### 5.2. –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –≤ `bot/db.py`

```python
# Dice Challenges
async def create_dice_challenge(self, challenge_id, chat_id, initiator_id, nickname, bet, going_debt, message_id)
async def get_pending_challenge(self, challenge_id) -> dict | None
async def get_active_challenge_by_user(self, user_id, chat_id) -> dict | None
async def get_active_challenge_in_chat(self, chat_id) -> dict | None  # –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
async def accept_challenge(self, challenge_id, opponent_id, opponent_nickname)
async def cancel_challenge(self, challenge_id)
async def expire_challenge(self, challenge_id)
async def record_roll(self, challenge_id, user_id, roll_value)
async def complete_challenge(self, challenge_id, winner_id)

# Debts
async def create_or_update_debt(self, debtor_id, creditor_id, amount, chat_id, challenge_id)
async def get_debt(self, chat_id, debtor_id, creditor_id) -> dict | None
async def get_total_debt_by_user(self, user_id, chat_id) -> list[dict]
async def get_debts_owed_to(self, creditor_id, chat_id) -> list[dict]
async def collect_debt(self, creditor_id, debtor_id, amount, chat_id)

# Stats extension
async def get_dice_stats(self, user_id, chat_id) -> dict  # wins, losses, draws
```

### 5.3. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ `__main__.py`

```python
from bot.handlers import dice_fight

# –ü–æ—Å–ª–µ –¥—Ä—É–≥–∏—Ö include_router:
dp.include_router(dice_fight.router)
```

### 5.4. Scheduled Jobs

–í `__main__.py` –¥–æ–±–∞–≤–∏—Ç—å:
```python
async def check_expired_challenges():
    """–û—Ç–º–µ–Ω—è–µ—Ç –≤—ã–∑–æ–≤—ã —Å—Ç–∞—Ä—à–µ 5 –º–∏–Ω—É—Ç"""
    await db.expire_old_challenges(minutes=5)

async def check_duel_timeouts():
    """–ê–≤—Ç–æ–±—Ä–æ—Å–æ–∫ –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤, –Ω–µ –±—Ä–æ—Å–∏–≤—à–∏—Ö –∫—É–±–∏–∫ –∑–∞ 5 –º–∏–Ω—É—Ç"""
    duels = await db.get_timed_out_duels(minutes=5)
    for duel in duels:
        await auto_roll_and_complete(duel, bot, db)

scheduler.add_job(check_expired_challenges, 'interval', minutes=1)
scheduler.add_job(check_duel_timeouts, 'interval', seconds=30)
```

---

## 6. Flow –¥–∏–∞–≥—Ä–∞–º–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         /dice 100                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü—Ä–æ–≤–µ—Ä–∫–∏:                                                           ‚îÇ
‚îÇ  ‚Ä¢ –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç –∏–∑ allowed_chat_ids?                                ‚îÇ
‚îÇ  ‚Ä¢ bet >= 1?                                                         ‚îÇ
‚îÇ  ‚Ä¢ bet <= balance + 100?                                             ‚îÇ
‚îÇ  ‚Ä¢ balance - bet >= -100?                                            ‚îÇ
‚îÇ  ‚Ä¢ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞?                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ –û–ö
                                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CREATE dice_challenge (status='pending')                            ‚îÇ
‚îÇ  –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å inline-–∫–Ω–æ–ø–∫–∞–º–∏ [–ü—Ä–∏–Ω—è—Ç—å] [üö´]                 ‚îÇ
‚îÇ  –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ message_id                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ                 ‚îÇ                 ‚îÇ
              ‚ñº                 ‚ñº                 ‚ñº
        [üö´ –û—Ç–º–µ–Ω–∞]      [–ü—Ä–∏–Ω—è—Ç—å –≤—ã–∑–æ–≤]    [–¢–∞–π–º–∞—É—Ç 5 –º–∏–Ω]
              ‚îÇ                 ‚îÇ                 ‚îÇ
              ‚ñº                 ‚îÇ                 ‚ñº
    status='cancelled'         ‚îÇ         status='expired'
    Edit message               ‚îÇ         Edit message
                               ‚îÇ
                               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–≥–æ:                                              ‚îÇ
‚îÇ  ‚Ä¢ –ù–µ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä?                                                     ‚îÇ
‚îÇ  ‚Ä¢ balance >= bet –ò–õ–ò balance + 100 >= bet?                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ –û–ö
                                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  UPDATE challenge: opponent_id, status='accepted', accepted_at       ‚îÇ
‚îÇ  Edit message: "–ë—Ä–æ—Å–∞–π—Ç–µ –∫—É–±–∏–∫!"                                     ‚îÇ
‚îÇ  Schedule timeout job (5 min)                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ                       ‚îÇ
                    ‚ñº                       ‚ñº
           –ò–≥—Ä–æ–∫ 1 –±—Ä–æ—Å–∞–µ—Ç üé≤      –ò–≥—Ä–æ–∫ 2 –±—Ä–æ—Å–∞–µ—Ç üé≤
           record_roll()           record_roll()
                    ‚îÇ                       ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ –û–±–∞ –±—Ä–æ—Å–∏–ª–∏?
                                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  process_duel_result():                                              ‚îÇ
‚îÇ  ‚Ä¢ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è                                            ‚îÇ
‚îÇ  ‚Ä¢ –†–∞—Å—á—ë—Ç –æ—á–∫–æ–≤ –∏ –¥–æ–ª–≥–∞                                              ‚îÇ
‚îÇ  ‚Ä¢ UPDATE balances                                                   ‚îÇ
‚îÇ  ‚Ä¢ CREATE/UPDATE debt (–µ—Å–ª–∏ –µ—Å—Ç—å)                                    ‚îÇ
‚îÇ  ‚Ä¢ ADD events                                                        ‚îÇ
‚îÇ  ‚Ä¢ UPDATE challenge: winner_id, status='completed'                   ‚îÇ
‚îÇ  ‚Ä¢ Send result message                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 7. Inline Keyboard

### 7.1. –ö–Ω–æ–ø–∫–∏ –≤—ã–∑–æ–≤–∞

```python
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

def get_challenge_keyboard(challenge_id: str, initiator_id: int) -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(
                text="‚öîÔ∏è –ü—Ä–∏–Ω—è—Ç—å –≤—ã–∑–æ–≤",
                callback_data=f"dice_accept:{challenge_id}"
            ),
            InlineKeyboardButton(
                text="üö´",
                callback_data=f"dice_cancel:{challenge_id}:{initiator_id}"
            )
        ]
    ])
```

### 7.2. Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

```python
@router.callback_query(F.data.startswith("dice_accept:"))
async def on_dice_accept(callback: CallbackQuery, db: Database):
    challenge_id = callback.data.split(":")[1]
    # ... –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è
    await callback.answer()

@router.callback_query(F.data.startswith("dice_cancel:"))
async def on_dice_cancel(callback: CallbackQuery, db: Database):
    parts = callback.data.split(":")
    challenge_id = parts[1]
    initiator_id = int(parts[2])
    
    if callback.from_user.id != initiator_id:
        await callback.answer("–¢–æ–ª—å–∫–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å –≤—ã–∑–æ–≤!", show_alert=True)
        return
    
    # ... –ª–æ–≥–∏–∫–∞ –æ—Ç–º–µ–Ω—ã
    await callback.answer("–í—ã–∑–æ–≤ –æ—Ç–º–µ–Ω—ë–Ω")
```

---

## 8. Edge Cases –∏ –∑–∞—â–∏—Ç–∞

### 8.1. –ü—Ä–æ–≤–µ—Ä–∫–∏

| –°–∏—Ç—É–∞—Ü–∏—è | –î–µ–π—Å—Ç–≤–∏–µ |
|----------|----------|
| –ò–≥—Ä–æ–∫ –ø—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–∏–Ω—è—Ç—å —Å–≤–æ–π –≤—ã–∑–æ–≤ | –û—à–∏–±–∫–∞: "–ù–µ–ª—å–∑—è –¥—Ä–∞—Ç—å—Å—è —Å —Å–∞–º–∏–º —Å–æ–±–æ–π!" |
| –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞ —É –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–≥–æ | –û—à–∏–±–∫–∞: "–¢–≤–æ–π –±–∞–ª–∞–Ω—Å {X}. –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º {bet} –∏–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–π—Ç–∏ –≤ –¥–æ–ª–≥." |
| –í—ã–∑–æ–≤ —É–∂–µ –ø—Ä–∏–Ω—è—Ç/–æ—Ç–º–µ–Ω—ë–Ω | callback.answer("–í—ã–∑–æ–≤ —É–∂–µ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω") |
| –ë—Ä–æ—Å–æ–∫ –∫—É–±–∏–∫–∞ –Ω–µ –æ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–∞ | –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å |
| /take –±–æ–ª—å—à–µ —á–µ–º –¥–æ–ª–≥ | –û—à–∏–±–∫–∞: "–î–æ–ª–≥ —Ç–æ–ª—å–∫–æ {X}!" |
| /take —É –∏–≥—Ä–æ–∫–∞ —Å 0 –±–∞–ª–∞–Ω—Å–æ–º | –û—à–∏–±–∫–∞: "–£ –¥–æ–ª–∂–Ω–∏–∫–∞ –±–∞–ª–∞–Ω—Å 0, –∂–¥–∏—Ç–µ –ø–æ–∫–∞ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç" |
| /take —É –∏–≥—Ä–æ–∫–∞ –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –¥–æ–ª–∂–µ–Ω | –û—à–∏–±–∫–∞: "–≠—Ç–æ—Ç –∏–≥—Ä–æ–∫ —Ç–µ–±–µ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–ª–∂–µ–Ω!" |

### 8.2. –¢–∞–π–º–∞—É—Ç—ã

- **–í—ã–∑–æ–≤ –±–µ–∑ –ø—Ä–∏–Ω—è—Ç–∏—è:** 5 –º–∏–Ω—É—Ç ‚Üí `status = 'expired'`
- **–î—É—ç–ª—å –±–µ–∑ –±—Ä–æ—Å–∫–æ–≤:** 5 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ `accepted_at` ‚Üí –∞–≤—Ç–æ–±—Ä–æ—Å–æ–∫ + –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ

---

## 9. –ü—Ä–∏–º–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π

### 9.1. –°–æ–∑–¥–∞–Ω–∏–µ –≤—ã–∑–æ–≤–∞

```
üé≤ –í–´–ó–û–í –ù–ê –î–£–≠–õ–¨!

üë§ @player1 —Å—Ç–∞–≤–∏—Ç 50 –æ—á–∫–æ–≤!

üí° –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å –≤—ã–∑–æ–≤.
‚è± –í—ã–∑–æ–≤ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç.

[‚öîÔ∏è –ü—Ä–∏–Ω—è—Ç—å –≤—ã–∑–æ–≤]  [üö´]
```

### 9.2. –í—ã–∑–æ–≤ —Å –¥–æ–ª–≥–æ–º

```
üé≤ –í–´–ó–û–í –ù–ê –î–£–≠–õ–¨!

üë§ @player1 —Å—Ç–∞–≤–∏—Ç 80 –æ—á–∫–æ–≤!
‚ö†Ô∏è –ò–≥—Ä–æ–∫ –∏–¥—ë—Ç –≤ –¥–æ–ª–≥! (–±–∞–ª–∞–Ω—Å: 30)

üí° –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å –≤—ã–∑–æ–≤.
‚è± –í—ã–∑–æ–≤ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç.

[‚öîÔ∏è –ü—Ä–∏–Ω—è—Ç—å –≤—ã–∑–æ–≤]  [üö´]
```

### 9.3. –î—É—ç–ª—å –Ω–∞—á–∞–ª–∞—Å—å

```
‚öîÔ∏è –î–£–≠–õ–¨ –ù–ê–ß–ê–õ–ê–°–¨!

üë§ @player1 vs üë§ @player2
üí∞ –°—Ç–∞–≤–∫–∞: 50 –æ—á–∫–æ–≤

–û—Ç–ø—Ä–∞–≤—å—Ç–µ üé≤ –≤ —á–∞—Ç –¥–ª—è –±—Ä–æ—Å–∫–∞!
‚è± –í—Ä–µ–º—è: 5 –º–∏–Ω—É—Ç
```

### 9.4. –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –ø–æ–±–µ–¥–∞

```
üé≤ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –î–£–≠–õ–ò

@player1: üé≤ 5
@player2: üé≤ 2

üèÜ @player1 –ø–æ–∫–∞–∑–∞–ª, –∫—Ç–æ —Ç—É—Ç –±–æ—Å—Å! +50 –≤ –∫–∞—Ä–º–∞–Ω!

üí∞ @player1: 150 –æ—á–∫–æ–≤
üí∞ @player2: 50 –æ—á–∫–æ–≤
```

### 9.5. –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –¥–æ–ª–≥

```
üé≤ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –î–£–≠–õ–ò

@player1: üé≤ 1
@player2: üé≤ 6

üòé @player2 –æ—Å—Ç–∞–≤–∏–ª @player1 –±–µ–∑ —à—Ç–∞–Ω–æ–≤! –õ—ë–≥–∫–∏–µ 80 –æ—á–∫–æ–≤!
üìâ @player1 —É—à—ë–ª –≤ –º–∏–Ω—É—Å! –î–æ–ª–≥: 50 –æ—á–∫–æ–≤ –ø–µ—Ä–µ–¥ @player2.

üí° –í–∑—ã—Å–∫–∞—Ç—å: /take 50 @player1

üí∞ @player2: 180 –æ—á–∫–æ–≤ (–ø–æ–ª—É—á–µ–Ω–æ 30 —Å –±–∞–ª–∞–Ω—Å–∞)
üí∞ @player1: 0 –æ—á–∫–æ–≤ (–¥–æ–ª–∂–µ–Ω 50 @player2)
```

### 9.6. –ù–∏—á—å—è

```
üé≤ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –î–£–≠–õ–ò

@player1: üé≤ 4
@player2: üé≤ 4

ü§ù –ù–∏—á—å—è! –û–±–∞ –≤—ã–±—Ä–æ—Å–∏–ª–∏ 4. –î–µ–Ω—å–≥–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–∏ —Å–≤–æ–∏—Ö!

üí∞ –ë–∞–ª–∞–Ω—Å—ã –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å.
```

### 9.7. /take —É—Å–ø–µ—Ö

```
üí∞ –í–∑—ã—Å–∫–∞–Ω–æ 50 –æ—á–∫–æ–≤ —Å @player1!

üìã –û—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞: 0 (–ø–æ–≥–∞—à–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é)
üí∞ –¢–≤–æ–π –±–∞–ª–∞–Ω—Å: 230 –æ—á–∫–æ–≤
```

### 9.8. –û—Ç–º–µ–Ω–∞ –≤—ã–∑–æ–≤–∞

```
üö´ –í—ã–∑–æ–≤ –æ—Ç–º–µ–Ω—ë–Ω

@player1 –ø–µ—Ä–µ–¥—É–º–∞–ª –¥—Ä–∞—Ç—å—Å—è.
```

### 9.9. –¢–∞–π–º–∞—É—Ç –≤—ã–∑–æ–≤–∞

```
‚è∞ –í—ã–∑–æ–≤ –∏—Å—Ç—ë–∫

–ù–∏–∫—Ç–æ –Ω–µ –ø—Ä–∏–Ω—è–ª –≤—ã–∑–æ–≤ @player1 –Ω–∞ 50 –æ—á–∫–æ–≤.
```

### 9.10. –ê–≤—Ç–æ–±—Ä–æ—Å–æ–∫

```
‚è∞ @player2 –Ω–µ —É—Å–ø–µ–ª –±—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫!
–ë–æ—Ç –±—Ä–æ—Å–∞–µ—Ç –∑–∞ –Ω–µ–≥–æ: üé≤ 3
```

---

## 10. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (settings.toml)

–î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é:

```toml
[dice_fights]
challenge_timeout_minutes = 5
roll_timeout_minutes = 5
max_debt = 100
min_bet = 1
```

–ò –º–æ–¥–µ–ª—å –≤ `config_reader.py`:

```python
class DiceFightsConfig(BaseModel):
    challenge_timeout_minutes: int = 5
    roll_timeout_minutes: int = 5
    max_debt: int = 100
    min_bet: int = 1
```

---

## 11. –ß–µ–∫–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã `dice_challenges` –∏ `player_debts` –≤ `db.py`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å —á–µ–ª–ª–µ–Ω–¥–∂–∞–º–∏ –≤ `db.py`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å –¥–æ–ª–≥–∞–º–∏ –≤ `db.py`
- [ ] –°–æ–∑–¥–∞—Ç—å `bot/handlers/dice_fight.py`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `/dice` –∫–æ–º–∞–Ω–¥—É
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å inline callbacks –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è/–æ—Ç–º–µ–Ω—ã
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –±—Ä–æ—Å–∫–æ–≤
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –∏ —Ä–∞—Å—á—ë—Ç–∞ –¥–æ–ª–≥–∞
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `/take` –∫–æ–º–∞–Ω–¥—É
- [ ] –î–æ–±–∞–≤–∏—Ç—å scheduled jobs –¥–ª—è —Ç–∞–π–º–∞—É—Ç–æ–≤
- [ ] –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `/stats` –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è PvP —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –¥–æ–ª–≥–æ–≤
- [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–æ—É—Ç–µ—Ä –≤ `__main__.py`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ `DiceFightsConfig`
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

---

## 12. –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ë–î

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –¥–æ–±–∞–≤–∏—Ç—å –≤ `create_tables()`:

```python
# 6. Dice Challenges table
await db.execute("""
    CREATE TABLE IF NOT EXISTS dice_challenges (...)
""")

# 7. Player Debts table  
await db.execute("""
    CREATE TABLE IF NOT EXISTS player_debts (...)
""")
```

–ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ —Å `try/except` –∫–∞–∫ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –∫–æ–¥–µ.

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 2026-01-21*
*–í–µ—Ä—Å–∏—è: 1.0*
