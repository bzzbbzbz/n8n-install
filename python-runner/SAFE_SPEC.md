# üîê –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è: Safe (–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å—á—ë—Ç)

## –û–±–∑–æ—Ä —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è "—Å–µ–π—Ñ–∞" ‚Äî –∑–∞—â–∏—â—ë–Ω–Ω–æ–≥–æ —Å—á—ë—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –∏–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å –æ—á–∫–∏. –û—á–∫–∏ –≤ —Å–µ–π—Ñ–µ **–Ω–µ —É—á–∞—Å—Ç–≤—É—é—Ç** –≤ –∏–≥—Ä–∞—Ö (—Å–ª–æ—Ç—ã, –¥—É—ç–ª–∏) –∏ **–∑–∞—â–∏—â–µ–Ω—ã –æ—Ç –≤–∑—ã—Å–∫–∞–Ω–∏—è –¥–æ–ª–≥–æ–≤** —á–µ—Ä–µ–∑ `/take`.

---

## 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### 1.1. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã `users`

–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ `safe_balance`:

```sql
ALTER TABLE users ADD COLUMN safe_balance INTEGER DEFAULT 0;
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü–æ–ª–µ —Ö—Ä–∞–Ω–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∫–æ–≤ –≤ —Å–µ–π—Ñ–µ. –í—Å–µ–≥–¥–∞ >= 0.

### 1.2. –ù–æ–≤—ã–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π –≤ `event_history`

| event_type | –û–ø–∏—Å–∞–Ω–∏–µ | amount | metadata |
|------------|----------|--------|----------|
| `safe_deposit` | –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–µ–π—Ñ–∞ | -—Å—É–º–º–∞ (—Å –±–∞–ª–∞–Ω—Å–∞) | `{"safe_balance_after": ...}` |
| `safe_withdraw` | –°–Ω—è—Ç–∏–µ –∏–∑ —Å–µ–π—Ñ–∞ | +—Å—É–º–º–∞ (–Ω–∞ –±–∞–ª–∞–Ω—Å) | `{"safe_balance_after": ...}` |

---

## 2. –ö–æ–º–∞–Ω–¥–∞ `/safe`

### 2.1. –°–∏–Ω—Ç–∞–∫—Å–∏—Å

```
/safe           ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å —Å–µ–π—Ñ–∞
/safe 50        ‚Äî –ø–æ–ª–æ–∂–∏—Ç—å 50 –æ—á–∫–æ–≤ –≤ —Å–µ–π—Ñ
/safe -50       ‚Äî —Å–Ω—è—Ç—å 50 –æ—á–∫–æ–≤ –∏–∑ —Å–µ–π—Ñ–∞
```

### 2.2. –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å

- –†–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö** –∏–∑ `allowed_chat_ids`
- –í –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

### 2.3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ | 1 |
| –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤ —Å–µ–π—Ñ–µ | –ë–µ–∑ –ª–∏–º–∏—Ç–∞ |
| Cooldown –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ | –ù–µ—Ç |
| –ö–æ–º–∏—Å—Å–∏—è | –ù–µ—Ç |
| –ü—Ä–æ—Ü–µ–Ω—Ç—ã –Ω–∞ –æ—Å—Ç–∞—Ç–æ–∫ | –ù–µ—Ç |

---

## 3. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

### 3.1. –ü—Ä–æ—Å–º–æ—Ç—Ä –±–∞–ª–∞–Ω—Å–∞ (`/safe`)

```python
@router.message(Command("safe"))
async def cmd_safe(message, command, db):
    if not command.args:
        safe_balance = await db.get_safe_balance(message.from_user.id)
        return f"üîê –í —Å–µ–π—Ñ–µ: {safe_balance} –æ—á–∫–æ–≤"
```

### 3.2. –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–µ–π—Ñ–∞ (`/safe N`, –≥–¥–µ N > 0)

**–£—Å–ª–æ–≤–∏—è:**
- `amount >= 1`
- `balance >= amount` (–Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º –±–∞–ª–∞–Ω—Å–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤)
- –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –¥—É—ç–ª–∏ –∏–ª–∏ –≤—ã–∑–æ–≤–∞ –Ω–∞ –¥—É—ç–ª—å (—Å—Ç–∞—Ç—É—Å—ã `pending`, `accepted`, `rolling`)

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```python
if amount < 1:
    return "‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 1 –æ—á–∫–æ"
if balance < amount:
    return f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ë–∞–ª–∞–Ω—Å: {balance}"

# –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
new_balance = balance - amount
new_safe_balance = safe_balance + amount
await db.update_balance(user_id, new_balance)
await db.update_safe_balance(user_id, new_safe_balance)
await db.add_event(user_id, "safe_deposit", -amount, {"safe_balance_after": new_safe_balance}, chat_id)

return f"‚úÖ –ü–æ–ª–æ–∂–µ–Ω–æ –≤ —Å–µ–π—Ñ: {amount}\nüîê –í —Å–µ–π—Ñ–µ: {new_safe_balance}\nüí∞ –ë–∞–ª–∞–Ω—Å: {new_balance}"
```

**–í–∞–∂–Ω–æ:** –ú–æ–∂–Ω–æ –∫–ª–∞—Å—Ç—å –≤ —Å–µ–π—Ñ –¥–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ–ª–≥–∏ (`player_debts`). –î–æ–ª–≥–∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ.

### 3.3. –°–Ω—è—Ç–∏–µ –∏–∑ —Å–µ–π—Ñ–∞ (`/safe -N` –∏–ª–∏ `/safe N`, –≥–¥–µ N < 0)

**–£—Å–ª–æ–≤–∏—è:**
- `amount >= 1` (–∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
- `safe_balance >= amount` (–≤ —Å–µ–π—Ñ–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤)

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```python
amount = abs(amount)  # /safe -50 ‚Üí amount = 50

if amount < 1:
    return "‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 1 –æ—á–∫–æ"
if safe_balance < amount:
    return f"‚ùå –í —Å–µ–π—Ñ–µ —Ç–æ–ª—å–∫–æ {safe_balance} –æ—á–∫–æ–≤"

# –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
new_balance = balance + amount
new_safe_balance = safe_balance - amount
await db.update_balance(user_id, new_balance)
await db.update_safe_balance(user_id, new_safe_balance)
await db.add_event(user_id, "safe_withdraw", amount, {"safe_balance_after": new_safe_balance}, chat_id)

return f"‚úÖ –°–Ω—è—Ç–æ –∏–∑ —Å–µ–π—Ñ–∞: {amount}\nüîê –í —Å–µ–π—Ñ–µ: {new_safe_balance}\nüí∞ –ë–∞–ª–∞–Ω—Å: {new_balance}"
```

**–í–∞–∂–Ω–æ:** –ú–æ–∂–Ω–æ —Å–Ω–∏–º–∞—Ç—å –∏–∑ —Å–µ–π—Ñ–∞ –ø—Ä–∏ –Ω—É–ª–µ–≤–æ–º –∏–ª–∏ –ª—é–±–æ–º –±–∞–ª–∞–Ω—Å–µ.

---

## 4. –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –º–µ—Ö–∞–Ω–∏–∫–∞–º–∏

### 4.1. –°–ª–æ—Ç—ã (üé∞)

–°–µ–π—Ñ **–Ω–µ –≤–ª–∏—è–µ—Ç** –Ω–∞ –∏–≥—Ä—É –≤ —Å–ª–æ—Ç—ã:
- –°—Ç–∞–≤–∫–∞ –±–µ—Ä—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å `balance`
- –ü—Ä–∏ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–µ (`balance <= 0`) —Å–µ–π—Ñ –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç—Å—è
- –ò–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å 0 –Ω–∞ –±–∞–ª–∞–Ω—Å–µ –∏ 1000 –≤ —Å–µ–π—Ñ–µ ‚Äî –æ–Ω –≤—Å—ë —Ä–∞–≤–Ω–æ –±–∞–Ω–∫—Ä–æ—Ç –¥–ª—è —Å–ª–æ—Ç–æ–≤

### 4.2. PvP –î—É—ç–ª–∏ (`/dice`)

–°–µ–π—Ñ **–Ω–µ –≤–ª–∏—è–µ—Ç** –Ω–∞ –¥—É—ç–ª–∏:
- –°—Ç–∞–≤–∫–∞ –∏ –ø—Ä–æ–∏–≥—Ä—ã—à –±–µ—Ä—É—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å `balance`
- –ü—Ä–∏ —É—Ö–æ–¥–µ –≤ –¥–æ–ª–≥ —Å–µ–π—Ñ –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç—Å—è
- –ò–≥—Ä–æ–∫ –º–æ–∂–µ—Ç —Å–ø—Ä—è—Ç–∞—Ç—å –¥–µ–Ω—å–≥–∏ –≤ —Å–µ–π—Ñ –∏ –∏–≥—Ä–∞—Ç—å "–≤ –¥–æ–ª–≥" ‚Äî —ç—Ç–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

### 4.3. –î–æ–ª–≥–∏ –∏ `/take`

**–ö—Ä–µ–¥–∏—Ç–æ—Ä –ù–ï –º–æ–∂–µ—Ç –≤–∑—ã—Å–∫–∞—Ç—å –¥–æ–ª–≥ –∏–∑ —Å–µ–π—Ñ–∞ –¥–æ–ª–∂–Ω–∏–∫–∞:**
- `/take` —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å `balance`
- –ï—Å–ª–∏ —É –¥–æ–ª–∂–Ω–∏–∫–∞ `balance = 0`, –Ω–æ `safe_balance = 100` ‚Äî –∫—Ä–µ–¥–∏—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω –∂–¥–∞—Ç—å
- –°–æ–æ–±—â–µ–Ω–∏–µ: `"–£ @user –±–∞–ª–∞–Ω—Å 0. –ñ–¥–∏—Ç–µ, –ø–æ–∫–∞ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç!"`

### 4.4. AI-–∫—Ä–µ–¥–∏—Ç (`/credit`)

**–ú–æ–∂–Ω–æ –±—Ä–∞—Ç—å –∫—Ä–µ–¥–∏—Ç –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –¥–µ–Ω–µ–≥ –≤ —Å–µ–π—Ñ–µ:**
- –£—Å–ª–æ–≤–∏–µ `/credit` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ `balance <= 0`
- –ï—Å–ª–∏ `balance = 0`, `safe_balance = 100` ‚Äî –∫—Ä–µ–¥–∏—Ç –¥–æ—Å—Ç—É–ø–µ–Ω
- –≠—Ç–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–∏–≥—Ä–æ–∫ —Å–∞–º —Ä–µ—à–∞–µ—Ç, —Ç—Ä–∞—Ç–∏—Ç—å —Å–µ–π—Ñ –∏–ª–∏ –±—Ä–∞—Ç—å –∫—Ä–µ–¥–∏—Ç)

### 4.5. –ü–µ—Ä–µ–≤–æ–¥—ã (`/give`)

**–°–µ–π—Ñ –ù–ï —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –ø–µ—Ä–µ–≤–æ–¥–∞—Ö:**
- –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Å–µ–π—Ñ–∞
- –ù–µ–ª—å–∑—è –ø–æ–ª—É—á–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ —Å–µ–π—Ñ
- –î–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ —Å–Ω—è—Ç—å –∏–∑ —Å–µ–π—Ñ–∞ –Ω–∞ –±–∞–ª–∞–Ω—Å

---

## 5. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### 5.1. –ù–æ–≤—ã–π handler: `bot/handlers/safe.py`

```
bot/handlers/safe.py
‚îú‚îÄ‚îÄ router = Router()
‚îÇ
‚îú‚îÄ‚îÄ @router.message(Command("safe"))
‚îÇ   async def cmd_safe(message, command, db)
‚îÇ   """–ü—Ä–æ—Å–º–æ—Ç—Ä / –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ / —Å–Ω—è—Ç–∏–µ –∏–∑ —Å–µ–π—Ñ–∞"""
```

### 5.2. –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –≤ `bot/db.py`

```python
# Safe
async def get_safe_balance(self, user_id: int) -> int
    """–ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å —Å–µ–π—Ñ–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""

async def update_safe_balance(self, user_id: int, amount: int) -> None
    """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å —Å–µ–π—Ñ–∞"""

async def safe_deposit(self, user_id: int, amount: int, chat_id: int) -> tuple[int, int]
    """–ê—Ç–æ–º–∞—Ä–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ —Å –±–∞–ª–∞–Ω—Å–∞ –≤ —Å–µ–π—Ñ. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (new_balance, new_safe_balance)"""

async def safe_withdraw(self, user_id: int, amount: int, chat_id: int) -> tuple[int, int]
    """–ê—Ç–æ–º–∞—Ä–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –∏–∑ —Å–µ–π—Ñ–∞ –Ω–∞ –±–∞–ª–∞–Ω—Å. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (new_balance, new_safe_balance)"""
```

### 5.3. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ `__main__.py`

```python
from bot.handlers import safe

# –ü–æ—Å–ª–µ –¥—Ä—É–≥–∏—Ö include_router:
dp.include_router(safe.router)
```

---

## 6. Flow –¥–∏–∞–≥—Ä–∞–º–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         /safe [amount]                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   –ï—Å—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç?      ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ           ‚îÇ
                     –ù–µ—Ç  ‚îÇ           ‚îÇ –î–∞
                          ‚ñº           ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ –ü–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å ‚îÇ ‚îÇ      –ü–∞—Ä—Å–∏–º amount          ‚îÇ
              ‚îÇ     —Å–µ–π—Ñ–∞       ‚îÇ ‚îÇ                             ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                ‚îÇ
                                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                    ‚îÇ                       ‚îÇ
                               amount > 0             amount < 0
                                    ‚îÇ                       ‚îÇ
                                    ‚ñº                       ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ      –ü–û–ü–û–õ–ù–ï–ù–ò–ï       ‚îÇ ‚îÇ       –°–ù–Ø–¢–ò–ï          ‚îÇ
                    ‚îÇ                       ‚îÇ ‚îÇ                       ‚îÇ
                    ‚îÇ –ü—Ä–æ–≤–µ—Ä–∫–∏:             ‚îÇ ‚îÇ –ü—Ä–æ–≤–µ—Ä–∫–∏:             ‚îÇ
                    ‚îÇ ‚Ä¢ amount >= 1?        ‚îÇ ‚îÇ ‚Ä¢ |amount| >= 1?      ‚îÇ
                    ‚îÇ ‚Ä¢ balance >= amount?  ‚îÇ ‚îÇ ‚Ä¢ safe >= |amount|?   ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ –û–ö                      ‚îÇ –û–ö
                                ‚ñº                         ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ balance -= amount     ‚îÇ ‚îÇ balance += |amount|   ‚îÇ
                    ‚îÇ safe += amount        ‚îÇ ‚îÇ safe -= |amount|      ‚îÇ
                    ‚îÇ event: safe_deposit   ‚îÇ ‚îÇ event: safe_withdraw  ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ                         ‚îÇ
                                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                             ‚ñº
                              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                              ‚îÇ   –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚îÇ
                              ‚îÇ   —Å –Ω–æ–≤—ã–º–∏ –±–∞–ª–∞–Ω—Å–∞–º–∏      ‚îÇ
                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 7. –ü—Ä–∏–º–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π

### 7.1. –ü—Ä–æ—Å–º–æ—Ç—Ä –±–∞–ª–∞–Ω—Å–∞ —Å–µ–π—Ñ–∞

**–ö–æ–º–∞–Ω–¥–∞:** `/safe`

```
üîê –í —Å–µ–π—Ñ–µ: 150 –æ—á–∫–æ–≤
üí∞ –ë–∞–ª–∞–Ω—Å: 50 –æ—á–∫–æ–≤
```

### 7.2. –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Äî —É—Å–ø–µ—Ö

**–ö–æ–º–∞–Ω–¥–∞:** `/safe 50`

```
‚úÖ –ü–æ–ª–æ–∂–µ–Ω–æ –≤ —Å–µ–π—Ñ: 50 –æ—á–∫–æ–≤

üîê –í —Å–µ–π—Ñ–µ: 200 –æ—á–∫–æ–≤
üí∞ –ë–∞–ª–∞–Ω—Å: 0 –æ—á–∫–æ–≤
```

### 7.3. –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Äî –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤

**–ö–æ–º–∞–Ω–¥–∞:** `/safe 100` (–ø—Ä–∏ –±–∞–ª–∞–Ω—Å–µ 30)

```
‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.

üí∞ –ë–∞–ª–∞–Ω—Å: 30 –æ—á–∫–æ–≤
üîê –í —Å–µ–π—Ñ–µ: 150 –æ—á–∫–æ–≤

–ú–∞–∫—Å–∏–º—É–º –º–æ–∂–Ω–æ –ø–æ–ª–æ–∂–∏—Ç—å: 30
```

### 7.4. –°–Ω—è—Ç–∏–µ ‚Äî —É—Å–ø–µ—Ö

**–ö–æ–º–∞–Ω–¥–∞:** `/safe -50`

```
‚úÖ –°–Ω—è—Ç–æ –∏–∑ —Å–µ–π—Ñ–∞: 50 –æ—á–∫–æ–≤

üîê –í —Å–µ–π—Ñ–µ: 100 –æ—á–∫–æ–≤
üí∞ –ë–∞–ª–∞–Ω—Å: 100 –æ—á–∫–æ–≤
```

### 7.5. –°–Ω—è—Ç–∏–µ ‚Äî –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤ —Å–µ–π—Ñ–µ

**–ö–æ–º–∞–Ω–¥–∞:** `/safe -200` (–ø—Ä–∏ safe_balance 100)

```
‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –≤ —Å–µ–π—Ñ–µ.

üîê –í —Å–µ–π—Ñ–µ: 100 –æ—á–∫–æ–≤
üí∞ –ë–∞–ª–∞–Ω—Å: 50 –æ—á–∫–æ–≤

–ú–∞–∫—Å–∏–º—É–º –º–æ–∂–Ω–æ —Å–Ω—è—Ç—å: 100
```

### 7.6. –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞

**–ö–æ–º–∞–Ω–¥–∞:** `/safe 0` –∏–ª–∏ `/safe abc`

```
‚ùå –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É: /safe 50 (–ø–æ–ª–æ–∂–∏—Ç—å) –∏–ª–∏ /safe -50 (—Å–Ω—è—Ç—å)
```

### 7.7. –ö–æ–º–∞–Ω–¥–∞ –≤ –õ–° (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ)

```
‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö.
```

---

## 8. Edge Cases –∏ –∑–∞—â–∏—Ç–∞

### 8.1. –ü—Ä–æ–≤–µ—Ä–∫–∏

| –°–∏—Ç—É–∞—Ü–∏—è | –î–µ–π—Å—Ç–≤–∏–µ |
|----------|----------|
| `/safe 0` | –û—à–∏–±–∫–∞: "–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É" |
| `/safe abc` | –û—à–∏–±–∫–∞: "–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É" |
| –ü–æ–ª–æ–∂–∏—Ç—å –±–æ–ª—å—à–µ —á–µ–º –±–∞–ª–∞–Ω—Å | –û—à–∏–±–∫–∞: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤" |
| –°–Ω—è—Ç—å –±–æ–ª—å—à–µ —á–µ–º –≤ —Å–µ–π—Ñ–µ | –û—à–∏–±–∫–∞: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤ —Å–µ–π—Ñ–µ" |
| `/safe` –≤ –õ–° | –û—à–∏–±–∫–∞: "–¢–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö" |
| –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤ safe_balance | –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–¥–µ) |
| –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –¥—É—ç–ª–∏ | –û—à–∏–±–∫–∞: "–ù–µ–ª—å–∑—è –∫–ª–∞—Å—Ç—å –≤ —Å–µ–π—Ñ –≤–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ–π –¥—É—ç–ª–∏" |

### 8.2. –û—Å–æ–±—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

| –°—Ü–µ–Ω–∞—Ä–∏–π | –ü–æ–≤–µ–¥–µ–Ω–∏–µ |
|----------|-----------|
| –ò–≥—Ä–æ–∫ —Å –¥–æ–ª–≥–æ–º –∫–ª–∞–¥—ë—Ç –≤ —Å–µ–π—Ñ | ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–æ |
| –ö—Ä–µ–¥–∏—Ç–æ—Ä –ø—ã—Ç–∞–µ—Ç—Å—è `/take` –∏–∑ —Å–µ–π—Ñ–∞ | ‚ùå –¢–æ–ª—å–∫–æ —Å –±–∞–ª–∞–Ω—Å–∞ |
| `/credit` –ø—Ä–∏ safe > 0, balance = 0 | ‚úÖ –ö—Ä–µ–¥–∏—Ç –¥–æ—Å—Ç—É–ø–µ–Ω |
| –ë–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–æ –ø—Ä–∏ safe > 0 | –°–µ–π—Ñ –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç—Å—è |
| –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –¥—É—ç–ª–∏/–≤—ã–∑–æ–≤–µ | ‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ |
| –°–Ω—è—Ç–∏–µ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –¥—É—ç–ª–∏/–≤—ã–∑–æ–≤–µ | ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–æ |

---

## 9. –ß–µ–∫–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `safe_balance` –≤ —Ç–∞–±–ª–∏—Ü—É `users` (–º–∏–≥—Ä–∞—Ü–∏—è)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã `get_safe_balance`, `safe_deposit`, `safe_withdraw` –≤ `db.py`
- [ ] –°–æ–∑–¥–∞—Ç—å `bot/handlers/safe.py`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ (—á–∏—Å–ª–æ, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä –±–∞–ª–∞–Ω—Å–∞
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–Ω—è—Ç–∏–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç
- [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–æ—É—Ç–µ—Ä –≤ `__main__.py`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `/take` ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–µ –±–µ—Ä—ë—Ç –∏–∑ —Å–µ–π—Ñ–∞ (—É–∂–µ —Ç–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `/credit` ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–º–æ—Ç—Ä–∏—Ç —Ç–æ–ª—å–∫–æ balance (—É–∂–µ —Ç–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç)

---

## 10. –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ë–î

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –¥–æ–±–∞–≤–∏—Ç—å –≤ `create_tables()`:

```python
# Safe balance field
try:
    await db.execute("ALTER TABLE users ADD COLUMN safe_balance INTEGER DEFAULT 0")
except:
    pass  # –ü–æ–ª–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
```

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 2026-01-22*
*–í–µ—Ä—Å–∏—è: 1.0*
